<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - TechHub Computer Components Store</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-light pt-5">
  <!-- Header will be loaded dynamically from client/src/components/header.html -->
  <header id="header-container"></header>

  <main class="py-5">
    <div class="container">
      <h1 class="fw-bold mb-4">Checkout</h1>

      <!-- Checkout Steps -->
      <div class="mb-5">
        <div class="position-relative m-4">
          <div class="progress" style="height: 3px;">
            <div class="progress-bar" role="progressbar" style="width: 66%;" aria-valuenow="66" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="position-absolute top-0 translate-middle" style="left: 0%">
            <button class="btn btn-primary btn-sm rounded-pill" disabled>1</button>
            <div class="mt-2 small">Cart</div>
          </div>
          <div class="position-absolute top-0 translate-middle" style="left: 66%">
            <button class="btn btn-primary btn-sm rounded-pill">2</button>
            <div class="mt-2 small fw-bold">Checkout</div>
          </div>
          <div class="position-absolute top-0 translate-middle" style="left: 100%">
            <button class="btn btn-light btn-sm rounded-pill">3</button>
            <div class="mt-2 small">Confirmation</div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Left Column - Checkout Form -->
        <div class="col-lg-8">
          <!-- Shipping Information -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-header bg-white py-3 border-0">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-geo-alt me-2 text-primary"></i> Shipping Information
              </h5>
            </div>
            <div class="card-body p-4">
              <form id="checkout-form" class="needs-validation" novalidate>
                <!-- Use Existing Address Toggle (for logged in users) -->
                <div id="address-toggle-container" class="mb-4 d-none">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="address-toggle" name="useExistingAddress">
                    <label class="form-check-label" for="address-toggle">
                      Use one of my saved addresses
                    </label>
                  </div>

                  <!-- Existing Address Selection (for logged in users) -->
                  <div id="existing-address-form" class="d-none mt-3">
                    <div class="mb-3">
                      <label for="address-select" class="form-label">Select Address</label>
                      <select class="form-select" id="address-select" name="addressId">
                        <!-- Addresses will be loaded dynamically -->
                      </select>
                    </div>
                  </div>
                </div>

                <!-- New Address Form -->
                <div id="new-address-form">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="email" class="form-label">Email Address</label>
                      <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span>
                        <input type="email" class="form-control" id="email" name="email" placeholder="you@example.com" required>
                      </div>
                      <div class="invalid-feedback">
                        Please enter a valid email address.
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="phone" class="form-label">Phone Number</label>
                      <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-telephone"></i></span>
                        <input type="tel" class="form-control" id="phone" name="phone" placeholder="For delivery communications" required>
                      </div>
                      <div class="invalid-feedback">
                        Please enter a valid phone number.
                      </div>
                    </div>
                    <div class="col-md-12">
                      <label for="fullName" class="form-label">Full Name</label>
                      <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                        <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Name as it appears on your ID" required>
                      </div>
                      <div class="invalid-feedback">
                        Please enter your full name.
                      </div>
                    </div>
                    <div class="col-12">
                      <label for="address" class="form-label">Address</label>
                      <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-house"></i></span>
                        <input type="text" class="form-control" id="address" name="address" placeholder="Street address, P.O. box, company name" required>
                      </div>
                      <div class="invalid-feedback">
                        Please enter your address.
                      </div>
                    </div>
                    <div class="col-12">
                      <label for="address2" class="form-label">Address Line 2 <span class="text-muted">(Optional)</span></label>
                      <input type="text" class="form-control" id="address2" name="address2" placeholder="Apartment, suite, unit, building, floor, etc.">
                    </div>
                    <div class="col-md-5">
                      <label for="country" class="form-label">Country</label>
                      <select class="form-select" id="country" name="country" required>
                        <option value="">Choose...</option>
                        <option value="VN" selected>Vietnam</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="UK">United Kingdom</option>
                        <option value="AU">Australia</option>
                        <option value="SG">Singapore</option>
                      </select>
                      <div class="invalid-feedback">
                        Please select a country.
                      </div>
                    </div>
                    <div class="col-md-4">
                      <label for="city" class="form-label">City</label>
                      <input type="text" class="form-control" id="city" name="city" required>
                      <div class="invalid-feedback">
                        Please enter your city.
                      </div>
                    </div>
                    <div class="col-md-3">
                      <label for="zip" class="form-label">Postal Code</label>
                      <input type="text" class="form-control" id="zip" name="zip" required>
                      <div class="invalid-feedback">
                        Please enter your postal code.
                      </div>
                    </div>
                    <div class="col-12">
                      <label for="state" class="form-label">State/Province</label>
                      <input type="text" class="form-control" id="state" name="state" required>
                      <div class="invalid-feedback">
                        Please enter your state or province.
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="save-address" name="saveAddress">
                        <label class="form-check-label" for="save-address">
                          Save this address for future orders
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-header bg-white py-3 border-0">
              <h5 class="mb-0 fw-bold">
                <i class="bi bi-credit-card me-2 text-primary"></i> Payment Method
              </h5>
            </div>
            <div class="card-body p-4">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <div class="payment-methods">
                    <div class="card mb-3 border-primary payment-method active">
                      <div class="card-body">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="paymentMethod" 
                                 id="credit-card" value="credit_card" checked>
                          <label class="form-check-label w-100" for="credit-card">
                            <div class="d-flex align-items-center">
                              <i class="bi bi-credit-card fs-3 me-3 text-primary"></i>
                              <div>
                                <div class="fw-medium">Credit / Debit Card</div>
                                <div class="text-muted small">Visa, Mastercard, American Express</div>
                              </div>
                              <div class="ms-auto">
                                <i class="bi bi-visa me-1 fs-4"></i>
                                <i class="bi bi-mastercard me-1 fs-4"></i>
                                <i class="bi bi-credit-card fs-4"></i>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="card mb-3 payment-method">
                      <div class="card-body">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="paymentMethod" 
                                 id="paypal" value="paypal">
                          <label class="form-check-label w-100" for="paypal">
                            <div class="d-flex align-items-center">
                              <i class="bi bi-paypal fs-3 me-3 text-primary"></i>
                              <div>
                                <div class="fw-medium">PayPal</div>
                                <div class="text-muted small">Pay with your PayPal account</div>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <div class="card mb-3 payment-method">
                      <div class="card-body">
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="paymentMethod" 
                                 id="bank-transfer" value="bank_transfer">
                          <label class="form-check-label w-100" for="bank-transfer">
                            <div class="d-flex align-items-center">
                              <i class="bi bi-bank fs-3 me-3 text-primary"></i>
                              <div>
                                <div class="fw-medium">Bank Transfer</div>
                                <div class="text-muted small">Pay via bank transfer (instructions will be sent by email)</div>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Credit Card Form (shows when credit card is selected) -->
                <div class="col-md-12" id="credit-card-form">
                  <div class="row g-3">
                    <div class="col-md-12">
                      <label for="name-on-card" class="form-label">Name on Card</label>
                      <input type="text" class="form-control" id="name-on-card" required>
                      <div class="invalid-feedback">
                        Please enter the name as it appears on your card.
                      </div>
                    </div>
                    <div class="col-md-12">
                      <label for="card-number" class="form-label">Card Number</label>
                      <div class="input-group">
                        <span class="input-group-text bg-light"><i class="bi bi-credit-card"></i></span>
                        <input type="text" class="form-control" id="card-number" placeholder="XXXX XXXX XXXX XXXX" required>
                      </div>
                      <div class="invalid-feedback">
                        Please enter a valid card number.
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="expiration" class="form-label">Expiration</label>
                      <input type="text" class="form-control" id="expiration" placeholder="MM/YY" required>
                      <div class="invalid-feedback">
                        Please enter a valid expiration date.
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="cvv" class="form-label">CVV</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="cvv" placeholder="XXX" required>
                        <span class="input-group-text bg-light" data-bs-toggle="tooltip" title="3-digit code on back of card">
                          <i class="bi bi-question-circle"></i>
                        </span>
                      </div>
                      <div class="invalid-feedback">
                        Please enter your CVV code.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Terms and Conditions -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="terms" required>
                <label class="form-check-label" for="terms">
                  I agree to the <a href="#" class="text-decoration-none">Terms and Conditions</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                </label>
                <div class="invalid-feedback">
                  You must agree to the terms and conditions before placing an order.
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-between">
            <a href="cart.html" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>Back to Cart
            </a>
            <button type="submit" class="btn btn-primary" id="place-order-btn">
              Place Order<i class="bi bi-arrow-right ms-2"></i>
            </button>
          </div>
        </div>

        <!-- Right Column - Order Summary -->
        <div class="col-lg-4">
          <!-- Order Summary -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-header bg-white py-3 border-0">
              <h5 class="card-title mb-0 fw-bold">Order Summary</h5>
            </div>
            <div class="card-body" id="checkout-cart-summary">
              <!-- Cart summary will be loaded dynamically -->
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading order summary...</p>
              </div>
            </div>
          </div>

          <!-- Discount Code -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
              <h6 class="fw-bold mb-3">Have a discount code?</h6>
              <div class="input-group">
                <input type="text" class="form-control" id="discount-code" placeholder="Enter code">
                <button class="btn btn-outline-primary" type="button" id="apply-discount">Apply</button>
              </div>
            </div>
          </div>

          <!-- Loyalty Points (for logged in users) -->
          <div id="loyalty-points" class="card border-0 shadow-sm rounded-4 mb-4 d-none">
            <div class="card-body p-4">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-star me-2 text-warning"></i>Loyalty Points
              </h6>
              <p class="mb-2">You have <span class="fw-bold text-primary" id="available-points">0</span> points available.</p>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="use-points">
                <label class="form-check-label" for="use-points">
                  Use my points for this order
                </label>
              </div>
            </div>
          </div>
          
          <!-- Secure Checkout -->
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-shield-lock me-2 text-success"></i>Secure Checkout
              </h6>
              <p class="small text-muted mb-0">
                Your personal information is encrypted and secure. We never store your credit card details.
              </p>
            </div>
          </div>
          
          <!-- Need Help? -->
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
              <h6 class="fw-bold mb-3">
                <i class="bi bi-question-circle me-2 text-primary"></i>Need Help?
              </h6>
              <p class="small text-muted mb-3">
                For assistance with your order, please contact our customer support:
              </p>
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-telephone me-3 text-muted"></i>
                <span>+84 123 456 789</span>
              </div>
              <div class="d-flex align-items-center">
                <i class="bi bi-envelope me-3 text-muted"></i>
                <span>support@techhub.com</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer will be loaded dynamically from client/src/components/footer.html -->
  <footer id="footer-container"></footer>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 for better alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.2/dist/sweetalert2.all.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load header and footer components
      loadComponents();
      
      // Simulate order summary data for demonstration
      setTimeout(() => loadCartSummary(), 800);
      
      // Setup form validation
      setupFormValidation();
      
      // Setup payment method selection
      setupPaymentMethodSelection();
      
      // Initialize tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      });
    });
    
    // Load header and footer components
    function loadComponents() {
      // Load header
      fetch('/client/src/components/header.html')
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load header: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(html => {
          document.getElementById('header-container').innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading header:', error);
          document.getElementById('header-container').innerHTML = `
            <div class="alert alert-danger m-3" role="alert">
              <h4 class="alert-heading">Error Loading Header</h4>
              <p>${error.message}</p>
              <hr>
              <p class="mb-0">Please check the path to your header component.</p>
            </div>
          `;
        });
      
      // Load footer
      fetch('/client/src/components/footer.html')
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load footer: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(html => {
          document.getElementById('footer-container').innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading footer:', error);
          document.getElementById('footer-container').innerHTML = `
            <div class="alert alert-danger m-3" role="alert">
              <h4 class="alert-heading">Error Loading Footer</h4>
              <p>${error.message}</p>
              <hr>
              <p class="mb-0">Please check the path to your footer component.</p>
            </div>
          `;
        });
    }
    
    // Setup form validation
    function setupFormValidation() {
      const form = document.getElementById('checkout-form');
      const placeOrderBtn = document.getElementById('place-order-btn');
      
      if (form && placeOrderBtn) {
        placeOrderBtn.addEventListener('click', function(event) {
          const termsCheckbox = document.getElementById('terms');
          
          // Add validation to the form
          form.classList.add('was-validated');
          
          // Check if form is valid and terms accepted
          if (!form.checkValidity() || !termsCheckbox.checked) {
            event.preventDefault();
            event.stopPropagation();
            
            // Scroll to first invalid field
            const invalidField = document.querySelector('.form-control:invalid');
            if (invalidField) {
              invalidField.focus();
            }
            
            // Check terms specifically
            if (!termsCheckbox.checked) {
              termsCheckbox.focus();
              // Show terms error with SweetAlert
              Swal.fire({
                title: 'Terms Required',
                text: 'Please accept the Terms and Conditions to proceed.',
                icon: 'warning',
                confirmButtonColor: '#0d6efd'
              });
            }
          } else {
            // Form is valid, show loading state
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
            
            // Simulate order processing
            setTimeout(() => {
              // Show success message
              Swal.fire({
                title: 'Order Placed!',
                text: 'Your order has been placed successfully! A confirmation email has been sent to your email address.',
                icon: 'success',
                confirmButtonColor: '#0d6efd'
              }).then(() => {
                // Redirect to order confirmation page
                window.location.href = 'order-confirmation.html?id=' + generateOrderId();
              });
            }, 2000);
          }
        });
        
        // Handle address toggle for logged in users
        const addressToggle = document.getElementById('address-toggle');
        if (addressToggle) {
          addressToggle.addEventListener('change', function() {
            const existingAddressForm = document.getElementById('existing-address-form');
            const newAddressForm = document.getElementById('new-address-form');
            
            if (this.checked) {
              existingAddressForm.classList.remove('d-none');
              newAddressForm.classList.add('d-none');
            } else {
              existingAddressForm.classList.add('d-none');
              newAddressForm.classList.remove('d-none');
            }
          });
        }
      }
    }
    
    // Setup payment method selection
    function setupPaymentMethodSelection() {
      const paymentMethods = document.querySelectorAll('.payment-method');
      const creditCardForm = document.getElementById('credit-card-form');
      
      paymentMethods.forEach(method => {
        const radio = method.querySelector('input[type="radio"]');
        
        // Add click event to entire card
        method.addEventListener('click', function() {
          // Select the radio button
          radio.checked = true;
          
          // Remove active class from all methods
          paymentMethods.forEach(m => {
            m.classList.remove('active');
            m.classList.remove('border-primary');
          });
          
          // Add active class to selected method
          method.classList.add('active');
          method.classList.add('border-primary');
          
          // Show/hide credit card form
          if (radio.id === 'credit-card') {
            creditCardForm.classList.remove('d-none');
          } else {
            creditCardForm.classList.add('d-none');
          }
        });
      });
    }
    
    // Load cart summary
    function loadCartSummary() {
      const cartSummaryContainer = document.getElementById('checkout-cart-summary');
      
      // Sample cart data
      const cartItems = [
        {
          name: "AMD Ryzen 9 5900X",
          variant: "Base Model",
          price: 499.99,
          quantity: 1
        },
        {
          name: "NVIDIA GeForce RTX 3080",
          variant: "10GB GDDR6X",
          price: 699.99,
          quantity: 1,
          salePrice: true
        },
        {
          name: "Samsung 970 EVO Plus",
          variant: "1TB NVMe M.2",
          price: 149.99,
          quantity: 2
        }
      ];
      
      let subtotal = 0;
      let itemsHtml = '';
      
      // Generate items HTML and calculate subtotal
      cartItems.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        itemsHtml += `
          <div class="d-flex justify-content-between mb-2">
            <div>
              <span class="fw-medium">${item.name}</span>
              <small class="d-block text-muted">${item.variant}</small>
              <small class="d-block text-muted">Qty: ${item.quantity}</small>
            </div>
            <span class="text-end ${item.salePrice ? 'text-danger' : ''}">${formatCurrency(itemTotal)}</span>
          </div>
        `;
      });
      
      // Calculate shipping, tax and total
      const shipping = subtotal > 100 ? 0 : 15;
      const tax = subtotal * 0.10; // 10% tax
      const discount = 0; // No discount applied initially
      const total = subtotal + shipping + tax - discount;
      
      // Update cart summary
      cartSummaryContainer.innerHTML = `
        <div class="mb-3">
          ${itemsHtml}
        </div>
        <hr>
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal</span>
          <span>${formatCurrency(subtotal)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Shipping</span>
          <span>${shipping === 0 ? 'FREE' : formatCurrency(shipping)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Tax (10%)</span>
          <span>${formatCurrency(tax)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Discount</span>
          <span id="discount-amount">${formatCurrency(discount)}</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between mb-2">
          <span class="fw-bold">Total</span>
          <span class="fw-bold fs-5 text-primary" id="checkout-total">${formatCurrency(total)}</span>
        </div>
        <div class="alert alert-light mt-3 mb-0 py-2 text-center">
          <small><i class="bi bi-truck text-primary me-1"></i> Free shipping on orders over $100</small>
        </div>
      `;
      
      // Setup discount code application
      setupDiscountCode(subtotal, shipping, tax);
    }
    
    // Setup discount code application
    function setupDiscountCode(subtotal, shipping, tax) {
      const applyDiscountBtn = document.getElementById('apply-discount');
      if (!applyDiscountBtn) return;
      
      applyDiscountBtn.addEventListener('click', function() {
        const discountCode = document.getElementById('discount-code').value.trim();
        
        if (!discountCode) {
          Swal.fire({
            title: 'Error',
            text: 'Please enter a discount code.',
            icon: 'error',
            confirmButtonColor: '#0d6efd'
          });
          return;
        }
        
        // Show loading state
        applyDiscountBtn.disabled = true;
        applyDiscountBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        
        // Simulate discount processing
        setTimeout(() => {
          // Reset button state
          applyDiscountBtn.disabled = false;
          applyDiscountBtn.innerHTML = 'Apply';
          
          // Apply 10% discount for demo
          const discountAmount = subtotal * 0.1;
          document.getElementById('discount-amount').innerHTML = `-${formatCurrency(discountAmount)}`;
          
          // Update total
          const newTotal = subtotal + shipping + tax - discountAmount;
          document.getElementById('checkout-total').textContent = formatCurrency(newTotal);
          
          // Show success message
          Swal.fire({
            title: 'Discount Applied!',
            text: `Discount code "${discountCode}" has been applied to your order.`,
            icon: 'success',
            confirmButtonColor: '#0d6efd'
          });
        }, 1500);
      });
    }
    
    // Format currency
    function formatCurrency(amount) {
      return '$' + amount.toFixed(2);
           + amount.toFixed(2);
    }
    
    // Generate a random order ID for demo purposes
    function generateOrderId() {
      const timestamp = new Date().getTime().toString().slice(-6);
      const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return `TH-${timestamp}-${random}`;
    }
    
    // Credit card form validation
    function setupCreditCardValidation() {
      const cardNumber = document.getElementById('card-number');
      const expiration = document.getElementById('expiration');
      const cvv = document.getElementById('cvv');
      
      if (cardNumber) {
        cardNumber.addEventListener('input', function(e) {
          // Format card number with spaces after every 4 digits
          let value = this.value.replace(/\D/g, '');
          if (value.length > 16) value = value.slice(0, 16);
          
          // Add spaces
          let formattedValue = '';
          for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) formattedValue += ' ';
            formattedValue += value[i];
          }
          
          this.value = formattedValue;
          
          // Validate
          if (value.length < 15) {
            this.classList.add('is-invalid');
          } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          }
        });
      }
      
      if (expiration) {
        expiration.addEventListener('input', function(e) {
          // Format MM/YY
          let value = this.value.replace(/\D/g, '');
          if (value.length > 4) value = value.slice(0, 4);
          
          // Add slash
          if (value.length > 2) {
            value = value.slice(0, 2) + '/' + value.slice(2);
          }
          
          this.value = value;
          
          // Validate
          const pattern = /^(0[1-9]|1[0-2])\/\d{2}$/;
          if (!pattern.test(this.value) && this.value.length > 0) {
            this.classList.add('is-invalid');
          } else if (this.value.length === 5) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          }
        });
      }
      
      if (cvv) {
        cvv.addEventListener('input', function(e) {
          // Numbers only, max 4 digits
          let value = this.value.replace(/\D/g, '');
          if (value.length > 4) value = value.slice(0, 4);
          this.value = value;
          
          // Validate
          if (value.length < 3) {
            this.classList.add('is-invalid');
          } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          }
        });
      }
    }
    
    // Check if user is logged in and show loyalty points
    function checkUserLogin() {
      // This would normally check for a token in localStorage
      const isLoggedIn = false; // Change to true to test loyalty points
      
      if (isLoggedIn) {
        // Show loyalty points section
        const loyaltyPoints = document.getElementById('loyalty-points');
        if (loyaltyPoints) {
          loyaltyPoints.classList.remove('d-none');
          
          // Set available points
          document.getElementById('available-points').textContent = '2,500';
          
          // Setup points usage checkbox
          const usePointsCheckbox = document.getElementById('use-points');
          if (usePointsCheckbox) {
            usePointsCheckbox.addEventListener('change', function() {
              const discountAmount = this.checked ? 25 : 0; // $1 = 100 points
              document.getElementById('discount-amount').textContent = this.checked ? `-${discountAmount.toFixed(2)}` : '$0.00';
              
              // Recalculate total
              const subtotalText = document.querySelector('.d-flex.justify-content-between:nth-child(1) span:last-child').textContent;
              const subtotal = parseFloat(subtotalText.replace(/[^0-9.-]+/g, ''));
              
              const shippingText = document.querySelector('.d-flex.justify-content-between:nth-child(2) span:last-child').textContent;
              const shipping = shippingText === 'FREE' ? 0 : parseFloat(shippingText.replace(/[^0-9.-]+/g, ''));
              
              const taxText = document.querySelector('.d-flex.justify-content-between:nth-child(3) span:last-child').textContent;
              const tax = parseFloat(taxText.replace(/[^0-9.-]+/g, ''));
              
              const total = subtotal + shipping + tax - discountAmount;
              document.getElementById('checkout-total').textContent = formatCurrency(total);
            });
          }
        }
        
        // Show saved addresses
        const addressToggleContainer = document.getElementById('address-toggle-container');
        if (addressToggleContainer) {
          addressToggleContainer.classList.remove('d-none');
          
          // Add some sample addresses to the select dropdown
          const addressSelect = document.getElementById('address-select');
          if (addressSelect) {
            addressSelect.innerHTML = `
              <option value="address1">Home: 123 Main St, Ho Chi Minh City, Vietnam</option>
              <option value="address2">Work: 456 Business Ave, District 1, Ho Chi Minh City, Vietnam</option>
            `;
          }
        }
      }
    }
    
    // Initialize additional features
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize credit card validation
      setupCreditCardValidation();
      
      // Check user login status
      checkUserLogin();
      
      // Handle country selection to update state/province field
      const countrySelect = document.getElementById('country');
      if (countrySelect) {
        countrySelect.addEventListener('change', function() {
          const stateField = document.getElementById('state');
          const stateLabel = stateField.previousElementSibling;
          
          // Update label based on country
          if (this.value === 'US') {
            stateLabel.textContent = 'State';
            stateField.placeholder = 'e.g. California, New York';
          } else if (this.value === 'CA') {
            stateLabel.textContent = 'Province';
            stateField.placeholder = 'e.g. Ontario, Quebec';
          } else if (this.value === 'AU') {
            stateLabel.textContent = 'State/Territory';
            stateField.placeholder = 'e.g. New South Wales, Victoria';
          } else if (this.value === 'UK') {
            stateLabel.textContent = 'County';
            stateField.placeholder = 'e.g. Greater London, Yorkshire';
          } else {
            stateLabel.textContent = 'State/Province';
            stateField.placeholder = '';
          }
        });
      }
    });